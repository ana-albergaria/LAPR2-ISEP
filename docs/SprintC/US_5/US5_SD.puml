@startuml

autonumber

actor "Medical Lab Technician" as MLT

participant ":RecordSamplesUI  " as UI
participant ":RecordSamplesController" as CTRL
participant ":Company" as COMPANY
participant "testStore\n:TestStore" as TEST_STORE
participant "selectedTest\n:Test" as SELECTED_TEST
participant "sampleStore\n:SampleStore" as SAMPLE_STORE
participant ":TestMapper" as TEST_MAPPER
participant "listTestsNoSamples\n:List<Test>" as LIST_TESTS_NO_SAMPLES
participant "listTestsNoSamplesDto\n:List<TestDto>" as LIST_TESTS_NO_SAMPLES_DTO
participant "sample\n:Sample" as SAMPLE
participant "api\n:ExternalAPI" as API
participant "barcode\n:Barcode" as BARCODE
participant "myBarcode\n:MyBarcode" as MY_BARCODE

activate MLT
MLT -> UI : asks to record the samples
activate UI

UI -> CTRL : listTestsNoSamplesDto = getTestsNoSamples()
activate CTRL

CTRL -> COMPANY : testStore = getTestStore()
activate COMPANY
|||
deactivate COMPANY

CTRL -> TEST_STORE : getTestsWithNoSamples()
activate TEST_STORE

ref over TEST_STORE
SD_getTestsWithNoSamples()
end

TEST_STORE --> CTRL : listTestsNoSamples
deactivate TEST_STORE
|||

CTRL -> TEST_MAPPER : toDTO(listTestsNoSamples)
activate TEST_MAPPER

ref over TEST_MAPPER
SD_toDTO(listTestsNoSamples)
end

TEST_MAPPER --> CTRL : listTestsNoSamplesDto
deactivate TEST_MAPPER

CTRL --> UI : listTestsNoSamplesDto
deactivate CTRL

UI --> MLT : shows list with tests with no samples collected and asks to select one
deactivate UI


MLT -> UI : selects test
activate UI

/'UI -> UI : selectedTestDto = (TestDto) Utils.showAndSelectOne(listTestWithNoSamplesDto, "msg")
activate UI
deactivate UI'/

/'note over UI, CTRL
The **code** refers to the code of the TestDto
selected by the Medical Lab Technician.
end note
UI -> CTRL : selectedTest = getTestByCode(code)
activate CTRL

CTRL -> COMPANY : testStore = getTestStore()
activate COMPANY
deactivate COMPANY

CTRL -> TEST_STORE : selectedTest = getTestByCode(code)
activate TEST_STORE
TEST_STORE --> SELECTED_TEST** : create()
TEST_STORE --> CTRL : selectedTest
deactivate TEST_STORE

CTRL --> UI : selectedTest'/

deactivate CTRL


UI --> MLT : asks the number of samples to collect
deactivate UI

MLT -> UI : types number
activate UI

UI --> MLT : requests confirmation
deactivate UI

MLT -> UI : confirms the data
activate UI

loop for each Sample to be recorded
UI -> CTRL : createSample()
activate CTRL

CTRL -> CTRL : getBarcode()
activate CTRL
ref over CTRL
SD_getBarcode()
end
CTRL --> CTRL : myBarcode
deactivate CTRL

CTRL -> COMPANY : sampleStore = getSampleStore()
activate COMPANY
|||
deactivate COMPANY


CTRL -> SAMPLE_STORE : sample = createSample(myBarcode)
activate SAMPLE_STORE

SAMPLE_STORE --> SAMPLE** : create(myBarcode)

SAMPLE -> SAMPLE : collectingDate = Calendar.getInstance.getTime()
activate SAMPLE
deactivate SAMPLE

deactivate SAMPLE_STORE

/'
SAMPLE -> SAMPLE : api = getExternalAPI()
activate SAMPLE
deactivate SAMPLE
'/


/'
SAMPLE -> API : barcode = getBarcode(barcodeNumber)
activate API
'/
/'
API --> BARCODE** : create(barcodeNumber)

API --> SAMPLE : barcode'/
/'deactivate SAMPLE'/
deactivate COMPANY
deactivate API

CTRL --> UI : result
deactivate CTRL



/'UI --> MLT : shows data and requests confirmation

MLT -> UI : confirms the data'/

/' SAVESAMPLE()
UI -> CTRL : saveSample()
activate CTRL

CTRL -> COMPANY : sampleStore = getSampleStore()
activate COMPANY
deactivate COMPANY

CTRL -> SAMPLE_STORE : saveSample(sample)
activate SAMPLE_STORE


SAMPLE_STORE -> SAMPLE_STORE : validateSample(sample)
activate SAMPLE_STORE
deactivate SAMPLE_STORE

SAMPLE_STORE -> SAMPLE_STORE : addSample(sample)
activate SAMPLE_STORE
deactivate SAMPLE_STORE

CTRL --> UI : result

deactivate SAMPLE_STORE
'/


note over UI, CTRL
The **code** refers to the code of the TestDto
selected by the Medical Lab Technician in step 12.
end note
UI -> CTRL : addSample(code)
activate CTRL




CTRL -> COMPANY : testStore = getTestStore()
activate COMPANY
deactivate COMPANY

CTRL -> TEST_STORE : getTestByCodeInTestList(code)
activate TEST_STORE
ref over TEST_STORE
SD_getTestByCodeInTestList()
end
TEST_STORE --> CTRL : selectedTest
deactivate TEST_STORE

CTRL -> SELECTED_TEST : addSample(sample)
activate SELECTED_TEST

SELECTED_TEST -> SELECTED_TEST : add(sample)
activate SELECTED_TEST
deactivate SELECTED_TEST

deactivate SELECTED_TEST


/'dentro do método addSample, vai-se verificar se a sample já está lá?'/

CTRL --> UI : result

UI -> CTRL : saveImageBarcode(code)

CTRL -> COMPANY : api = getExternalApi()
activate COMPANY
deactivate COMPANY

CTRL -> SAMPLE : myBarcode = getMyBarcode()
activate SAMPLE
deactivate SAMPLE

CTRL -> API : saveImageBarcode(myBarcode, code)
activate API
deactivate API

CTRL --> UI : result

deactivate CTRL

end

UI --> MLT : informs operation success


/'colocar requests confirmation
e confirms the data em cima'/



@enduml