@startuml
autonumber
'hide footbox
actor "Laboratory coordinator" as ADM

participant ":ImportTestUI  " as UI
participant ":ImportTestController" as CTRL
participant "testFile:TestFileUtils" as TST
participant "List<Test>:" as TST
participant ":Company" as PLAT
participant ":RegisterClientController" as CLIENT_CTRL
participant ":CreateTestController" as ORG
participant "store:TestStore" as TEST_STORE
participant "createdTest: Test" as CREATED_TEST


activate ADM
ADM -> UI : asks to import clinical tests from a CSV file.
activate UI


UI --> ADM : shows the file chooser and asks to select the file.
deactivate UI


ADM -> UI : selects requested data
activate UI
UI -> CTRL : createTestsFromFile(pathOfFile)
activate CTRL

CTRL -> TST : List<String[]>processedListData = getTestDataByFile(pathOfFile)
activate TST
deactivate TST

/'
CTRL -> TEST_LIST** : create()
'/


CTRL -> PLAT : clientStore = getClientStore()
activate PLAT
deactivate PLAT

CTRL -> CLIENT_CTRL** : createClientCtrl = create()


CTRL -> ORG** : createTestCtrl = create(currentCalCode)


loop for each String [] of the list
note right of CTRL: all data refered in the following steps is extracted \nfrom the .CSV file and stored at each index of each String [] of the list.

alt client not existent with given tin
CTRL -> CLIENT_CTRL : createClient(clientDto)
activate CLIENT_CTRL
deactivate CLIENT_CTRL
CTRL -> CLIENT_CTRL : saveClient()
activate CLIENT_CTRL
deactivate CLIENT_CTRL
end

CTRL -> TST : List<String> parameterCodes = getParameterCodes(String[] processedData)
activate TST
deactivate TST

CTRL -> ORG : createTest(NHScode, tinNumber, testTypeCode, paramCodes)
activate ORG
deactivate ORG

CTRL -> ORG : saveTest()
activate ORG
deactivate ORG

CTRL -> TEST_STORE : createdTest = getTestByNhsNumber(nhsNumber)
activate TEST_STORE
deactivate TEST_STORE

CTRL -> TST : List<Double> parameterResults = getParameterResults(String[] processedData)
activate TST
deactivate TST

loop for each test parameter code
CTRL -> CREATED_TEST : createdTest.addTestResult(parameterCode, parameterResult)
activate CREATED_TEST
deactivate CREATED_TEST
end

CTRL -> CREATED_TEST : setRegDate(regDate)
activate CREATED_TEST
deactivate CREATED_TEST

CTRL -> CREATED_TEST : setChemicalDate(chemicalDate)
activate CREATED_TEST
deactivate CREATED_TEST

CTRL -> CREATED_TEST : setReportData(reportDate)
activate CREATED_TEST
deactivate CREATED_TEST

/'CTRL -> TEST_LIST : createdTestsList.add(createdTest)
activate TEST_LIST
deactivate TEST_LIST'/
end

/'CTRL -> TEST_LIST : resultSize = createdTestsList.size()
activate TEST_LIST
deactivate TEST_LIST'/


deactivate CTRL

CTRL --> UI: result

UI --> ADM : informs operation success
deactivate ORG
deactivate CTRL
deactivate UI

deactivate ADM

@enduml
